# How to Update PackItForms

Most of the code dealing with PackItForms is auto-generated by scanning the
PackItForms source code itself (specifically, the HTML form files).  When a new
version of PackItForms comes out and this code needs to adapt to new forms,
follow these instructions.

## Step 1:  Update PackItForms Source Code

If you haven't checked out the PackItForms source code before:

    > cd ..       # (i.e., the directory above "packet")
    > git clone https://github.com/jmkristian/pack-it-forms
    > cd packet   # (i.e., return to the "packet" directory)

If you have it already checked out and you need to update it:

    > cd ../pack-it-forms
    > git pull
    > cd ../packet

## Step 2:  Update the HTML Files in the Packet Tree

The packet source code tree contains copies of the PackItForms form HTML files
from various versions of PackItForms.  Some of these may have changed and need
to be updated.  Also, there may be new versions of some forms that need to be
copied.  To do these things:

    > go run ./gen/get-pifo-html

(Note:  get-pifo-html assumes that the PackItForms source code is at
`../pack-it-forms` and that the output files should go in `./xscmsg/internal`.
Both of these assumptions are correct if you're following these instructions.
But if you need to do something else, you can override those paths on the
get-pifo-html command line.)

If the new PackItForms version has a new type of form in it, this command will
fail with a message like:

    Tag vSCCo.99 contains an unknown form form-doughnut-order.html.

If that happens, you'll need to edit `./gen/get-pifo-html/main.go` and add that
form to the table at the top of the file.  If it's a form we don't care about,
it can be mapped to an empty string.  Otherwise, it needs to be mapped to an
identifier resembling the form name.  The identifier must start with a lowercase
letter and contain only lowercase letters and digits.  Once that change is made,
run get-pifo-html again.

The HTML files are stored in `./xscmsg/internal/«formtype»/*.html`.  Note that
any "include" directives in the original HTML file have been followed; the
resulting HTML files are self-contained.

By default, get-pifo-html only gets HTML files from PackItForms versions that
are new since the last time it was run.  If for some reason you need to
regenerate them all, remove the `./xscmsg/internal/tags-read` file, remove all
existing `*.html` files, and re-run get-pifo-html.

## Step 3:  Update the Form Definitions

In this step, we run the extract-pifo-fields tool.  It reads the HTML files we
fetched, and generates a Go source file for each one (i.e., for each version of
each form), containing information about the fields of the form.  To run this
tool:

    > go run ./gen/extract-pifo-html

This creates a `*.def.go` file next to each `*.html` file.

## Step 4:  Verify and Correct the Form Definitions

The above tools do 98% of the work.  But sometimes there are oddities in the
PackItForms HTML files that we don't want to have in this library.  So, read
over the field definitions created by the extract-pifo-fields tool.  (Really,
you only need to read over the ones for new or updated form versions.)

Pay particular attention to fields that are implemented as combo boxes in the
PackItForms HTML.  The extractor isn't able to read those from PackItForms
properly, so those fields and their pre-defined values are hard-coded in the
extractor tool (file `gen/extract-pifo-fields/fixups.go`).  They will need to be
manually updated if they change.

If you see any issues that need to be corrected, don't edit those `*.def.go`
files; your changes would be lost the next time anyone regenerates them.
Instead, edit the source code for the extract-pifo-fields tool.  Simple changes
can be put in the `fixups.go` file mentioned above.  Alternatively, if
PackItForms has made some widespread change that is causing errors in all forms,
you can update the parser in extract-pifo-fields to adapt to the change and then
re-run it.

## Step 5:  Address Prototype Form Versions

On occasion, PackItForms will include a new version of a form, but continue to
use the older version of it as the default version.  When creating a new form,
this library always uses the most current version.  If you need to override
that, change the code of the `Create` function in the form's package to do so.

## Step 6:  Commit Changes

After appropriate testing, commit all changes to the repository.
